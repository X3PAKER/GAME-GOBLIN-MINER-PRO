const express = require('express');
const bodyParser = require('body-parser');
const cors = require('cors');
const Database = require('better-sqlite3');
const db = new Database('data.db');

db.prepare(`CREATE TABLE IF NOT EXISTS withdraws (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  wallet TEXT, network TEXT, amount REAL, status TEXT, pass TEXT, createdAt TEXT
)`).run();

const app = express();
app.use(cors()); app.use(bodyParser.json());

// create withdraw
app.post('/api/withdraw', (req, res)=>{
  const { wallet, network, amount, pass } = req.body;
  if(!wallet || !amount || !pass) return res.status(400).json({message:'Invalid'});
  // optionally validate pass server-side (or accept as is)
  const stmt = db.prepare('INSERT INTO withdraws (wallet, network, amount, status, pass, createdAt) VALUES (?,?,?,?,?,?)');
  const info = stmt.run(wallet, network, amount, 'PENDING', pass, new Date().toISOString());
  res.json({id: info.lastInsertRowid});
});

// list withdraws
app.get('/api/withdraws', (req, res)=>{
  const rows = db.prepare('SELECT id,wallet,network,amount,status,createdAt FROM withdraws ORDER BY id DESC').all();
  res.json(rows);
});

// admin mark as sent (call with admin auth in prod)
app.post('/api/admin/mark/:id', (req,res)=>{
  const id = req.params.id;
  db.prepare('UPDATE withdraws SET status = ? WHERE id = ?').run('SENT', id);
  res.json({ok:true});
});

// optional: get single
app.get('/api/withdraw/:id', (req,res)=>{
  const row = db.prepare('SELECT * FROM withdraws WHERE id=?').get(req.params.id);
  res.json(row||{});
});

const port = process.env.PORT || 4000;
app.listen(port, ()=>console.log('listening', port));
